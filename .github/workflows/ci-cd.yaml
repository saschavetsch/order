# Workflow name that appears in GitHub Actions UI
name: CI/CD Order

# Define when this workflow will run
on:
  push:
    branches:
      - main      # Trigger on pushes to main branch
      - nom-105-cicd-pipeline
  pull_request:
    branches:
      - main      # Trigger on PRs targeting main branch

jobs:
  build:
    # Specify the runner environment
    runs-on: ubuntu-24.04

    steps:
      # Step 1: Check out the repository code
      - uses: actions/checkout@v4 

      # Step 2: Configure Java Development Kit
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'     # Use Eclipse Temurin distribution
          java-version: '21'          # Specify Java version 21

      # Step 3: Cache Maven dependencies to speed up builds
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2                                               # Location of Maven cache
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}   # Cache key based on OS and pom.xml
          restore-keys: ${{ runner.os }}-m2                         # Fallback cache key (if path to cache not found)

      # Step 5: Pull latest image of catalog for Playwright tests
      - name: Pull latest image of catalog
        run: docker pull ${{ secrets.DOCKERHUB_USERNAME }}/catalog:latest

      - name: Start catalog service
        run: docker run -d -p 8080:8080 --name catalog-app ${{ secrets.DOCKERHUB_USERNAME }}/catalog:latest

      # Step 4: Build the project using Maven
      - name: Build with Maven
        # Run Maven Spring-Boot build-image task (includes test and package)
        # First -> check if catalog service is up and running
        # Execute a multi-line script for the run method -> | (pipe)
        run: |
          timeout=60
          while ! curl -s http://localhost:8080/actuator/health | grep -q '"status":"UP"'
          do
            if [ $timeout -le 0 ]; then
              echo "Timed out waiting for catalog service!"
              exit 1
            fi
            echo "Waiting for catalog service to be ready..."
            sleep 5
            timeout=$((timeout - 5))
          done
          echo "Catalog service is ready!"
          mvn spring-boot:build-image jacoco:report   

      # New Step: Upload test results as artifacts
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()                        # Always upload test results
        with:
          name: test-reports
          path: target/surefire-reports/
          retention-days: 7

      - name: Stop and remove other app container
        run: |
          docker stop catalog-app
          docker rm catalog-app

      # Step 6: Authenticate with DockerHub
      # https://hub.docker.com/u/saschavetsch
      - name: Login to DockerHub
        uses: docker/login-action@v3                    # Official Docker login action
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}   # Username from GitHub secrets
          password: ${{ secrets.DOCKERHUB_TOKEN }}      # Access token from GitHub secrets

      # Step 7: Build and push Docker image
      - name: Build and push Docker image
        uses: docker/build-push-action@v3                           # Official Docker build and push action
        with:
          context: .                                                # Build context is root directory
          push: true                                                # Actually push the image
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/order:latest    # Image name and tag

      # Step 8: Generate and publish code coverage report
      - name: Upload JaCoCo coverage report
        uses: actions/upload-artifact@v4      # Action for publishing JaCoCo reports
        with:
          name: jacoco-report
          path: target/site/jacoco/           # Path to JaCoCo report
          retention-days: 7